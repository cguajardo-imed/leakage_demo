name: Scan for secrets SARIF output

on:
  workflow_call:
    inputs:
      env:
        description: "Specifies the country name + environment. Ex: cl-qa, ec-int"
        required: true
        type: string
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  id-token: write
  contents: write  # ← Changed to WRITE (needed for docker build/push)
  issues: write
  packages: write  # ← Changed to WRITE (needed for GHCR)
  actions: write   # ← Added for private action access + artifacts

jobs:
  test_job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: checking gitleaks action
        uses: cguajardo-imed/action@v0.0.12
        id: gitleaks
        with:
          report_format: sarif
          stop_on_failure: false

      - name: Get Gitleaks Results
        if: always()
        run: |
          echo "Scan successful: ${{ steps.gitleaks.outputs.success }}"
          echo "Leaks found: ${{ steps.gitleaks.outputs.leaks_found }}"
          echo "Report path: ${{ steps.gitleaks.outputs.report_path }}"

      - name: Build docker image
        run: |
          docker build --build-arg NPM_TOKEN=${{ secrets.NPM_TOKEN }} -t test:latest .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: "image"
          scan-ref: "test:latest"
          format: "json"
          output: "trivy-report.json"
          severity: "HIGH,CRITICAL"
          exit-code: "0"
          ignore-unfixed: true
          skip-dirs: "**/.npm/**"

      - name: Convert JSON to SARIF
        run: |
          trivy convert --format sarif --output trivy-report.sarif trivy-report.json

      - name: Convert JSON to table and show
        run: |
          trivy convert --format table --output trivy-report.txt trivy-report.json
          cat trivy-report.txt

      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-${{ github.event.repository.name }}-${{ inputs.env || 'default' }}
          path: trivy-report.sarif

      - name: Imed Cortex Action
        uses: cguajardo-imed/cortex-uploader-action@v0.0.3
        with:
          endpoint_url: 'https://vc.cl-qa.imedlatam.com/api/upload/sarif/${{ github.event.repository.name }}'
          api_key: ${{ secrets.CTOKEN }}
          report_path: './trivy-report.sarif'
